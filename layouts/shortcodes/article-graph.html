{{/* 
  Article Graph Shortcode
  Génère automatiquement un mini-graphe basé sur les tags de l'article
  Usage: {{< article-graph >}}
*/}}

<div class="graph-container" style="margin: 2rem 0;">
  <h4 class="graph-title" style="color: var(--kanagawa-accent, #E46876); margin-bottom: 1rem;">
    <i class="fa-solid fa-diagram-project"></i>
    Connexions de cet article
  </h4>
  <div id="article-graph-{{ .Page.File.UniqueID }}"></div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="/js/knowledge-graph.js"></script>

<script>
(function() {
  // Récupérer les données depuis Hugo
  const tags = {{ .Page.Params.tags | default (slice) | jsonify }};
  const categories = {{ .Page.Params.categories | default (slice) | jsonify }};
  const title = {{ .Page.Title | jsonify }};
  const containerId = "article-graph-{{ .Page.File.UniqueID }}";
  
  // Construire les nodes
  const nodes = [
    { id: 'article', label: title, isCenter: true, url: '{{ .Page.Permalink }}' }
  ];
  const links = [];
  
  // Ajouter les tags
  tags.forEach(function(tag) {
    const tagId = 'tag-' + tag.toLowerCase().replace(/\s+/g, '-');
    nodes.push({ 
      id: tagId, 
      label: tag, 
      url: '/tags/' + tag.toLowerCase().replace(/\s+/g, '-') + '/',
      category: 'tag'
    });
    links.push({ source: 'article', target: tagId });
  });
  
  // Ajouter les catégories
  categories.forEach(function(cat) {
    const catId = 'cat-' + cat.toLowerCase().replace(/\s+/g, '-');
    nodes.push({ 
      id: catId, 
      label: cat, 
      url: '/categories/' + cat.toLowerCase().replace(/\s+/g, '-') + '/',
      category: 'category'
    });
    links.push({ source: 'article', target: catId });
  });
  
  // Créer des connexions entre tags liés (optionnel)
  // Ceci crée un graphe plus intéressant visuellement
  if (tags.length > 1) {
    for (let i = 0; i < tags.length - 1; i++) {
      const tagId1 = 'tag-' + tags[i].toLowerCase().replace(/\s+/g, '-');
      const tagId2 = 'tag-' + tags[i+1].toLowerCase().replace(/\s+/g, '-');
      links.push({ source: tagId1, target: tagId2 });
    }
  }
  
  // Initialiser le graphe seulement si on a des données
  if (nodes.length > 1) {
    document.addEventListener('DOMContentLoaded', function() {
      new KnowledgeGraph(containerId, { nodes: nodes, links: links }, {
        height: 350,
        nodeRadius: 7,
        centerNodeRadius: 12,
        linkDistance: 80,
        chargeStrength: -200
      });
    });
  } else {
    // Pas de tags/catégories, afficher un message
    document.getElementById(containerId).innerHTML = 
      '<p style="color: var(--kanagawa-fg-muted, #727169); text-align: center; padding: 2rem;">Ajoutez des tags à cet article pour voir le graphe.</p>';
  }
})();
</script>
