{{/*
  Knowledge Graph Shortcode - Dynamic Version
  Usage: {{< knowledge-graph >}}

  Automatically generates graph from all posts, projects, and tags
*/}}

<style>
  .graph-container {
    position: relative;
    z-index: 1;
    margin: 1.5rem 0 2rem;
    overflow: visible;
  }
  .graph-container .graph-title {
    margin-bottom: 1rem;
  }
  #knowledge-graph {
    position: relative;
    z-index: 1;
    overflow: hidden;
    border-radius: 8px;
  }
  #knowledge-graph svg {
    display: block;
    pointer-events: all;
  }
  /* Ensure content after graph doesn't overlap */
  .graph-container + * {
    position: relative;
    z-index: 0;
  }
</style>

<div class="graph-container">
  <h3 class="graph-title">
    <i class="fa-solid fa-diagram-project"></i>
    Interactive Knowledge Graph
  </h3>
  <div id="knowledge-graph"></div>
</div>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="/js/knowledge-graph.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Dynamically generated graph data from Hugo
  const graphData = {
    nodes: [
      // Center node
      {
        id: 'center',
        label: 'Ben Warai Otoko',
        isCenter: true,
        url: '/',
        category: 'central'
      },

      // Main pages
      { id: 'about', label: 'About', url: '/about/', category: 'page' },
      { id: 'posts', label: 'Blog', url: '/posts/', category: 'page' },
      { id: 'projects', label: 'Projects', url: '/projects/', category: 'page' },
      { id: 'learning-logs', label: 'Learning Logs', url: '/learning-logs/', category: 'page' },
      { id: 'second-brain', label: 'Second Brain', url: '/second-brain/', category: 'page' },

      // Tags (generated from site taxonomies)
      {{ range $name, $taxonomy := .Site.Taxonomies.tags -}}
      {
        id: 'tag-{{ $name | urlize }}',
        label: '{{ $name | title }}',
        url: '/tags/{{ $name | urlize }}/',
        category: 'skill',
        count: {{ len $taxonomy }}
      },
      {{ end -}}

      // Posts, Projects, Learning Logs, and Second Brain
      {{ range where .Site.RegularPages "Section" "in" (slice "posts" "projects" "learning-logs" "second-brain") -}}
      {{ if not .Draft -}}
      {
        id: 'content-{{ .File.UniqueID }}',
        label: '{{ .Title }}',
        url: '{{ .RelPermalink }}',
        category: '{{ if eq .Section "projects" }}project{{ else if eq .Section "learning-logs" }}learning{{ else if eq .Section "second-brain" }}brain{{ else }}post{{ end }}',
        tags: [{{ range .Params.tags }}'{{ . | urlize }}',{{ end }}]
      },
      {{ end -}}
      {{ end -}}
    ],

    links: [
      // Center connects to main pages
      { source: 'center', target: 'about' },
      { source: 'center', target: 'posts' },
      { source: 'center', target: 'projects' },
      { source: 'center', target: 'learning-logs' },
      { source: 'center', target: 'second-brain' },

      // Center connects to primary skills
      {{ $primaryTags := slice "python" "sql" "data-engineering" "etl" "video" "broadcast" "ffmpeg" "automation" -}}
      {{ range $primaryTags -}}
      {{ if index $.Site.Taxonomies.tags (. | urlize) -}}
      { source: 'center', target: 'tag-{{ . | urlize }}' },
      {{ end -}}
      {{ end -}}

      // Content connects to their tags and parent sections
      {{ range where .Site.RegularPages "Section" "in" (slice "posts" "projects" "learning-logs" "second-brain") -}}
      {{ if not .Draft -}}
      {{ $contentID := printf "content-%s" .File.UniqueID -}}
      {{ range .Params.tags -}}
      { source: '{{ $contentID }}', target: 'tag-{{ . | urlize }}' },
      {{ end -}}

      // Content connects to its parent section
      {{ if eq .Section "projects" -}}
      { source: '{{ $contentID }}', target: 'projects' },
      {{ else if eq .Section "learning-logs" -}}
      { source: '{{ $contentID }}', target: 'learning-logs' },
      {{ else if eq .Section "second-brain" -}}
      { source: '{{ $contentID }}', target: 'second-brain' },
      {{ else -}}
      { source: '{{ $contentID }}', target: 'posts' },
      {{ end -}}
      {{ end -}}
      {{ end -}}

      // Create connections between related tags (tags that appear together)
      {{ $tagConnections := dict -}}
      {{ range where .Site.RegularPages "Section" "in" (slice "posts" "projects" "learning-logs" "second-brain") -}}
      {{ if not .Draft -}}
      {{ $postTags := .Params.tags -}}
      {{ range $i, $tag1 := $postTags -}}
      {{ range $j, $tag2 := $postTags -}}
      {{ if and (ne $i $j) (lt $i $j) -}}
      {{ $key := printf "%s-%s" ($tag1 | urlize) ($tag2 | urlize) -}}
      {{ $tagConnections = merge $tagConnections (dict $key true) -}}
      {{ end -}}
      {{ end -}}
      {{ end -}}
      {{ end -}}
      {{ end -}}

      // Output tag-to-tag connections
      {{ range $key, $_ := $tagConnections -}}
      {{ $parts := split $key "-" -}}
      {{ if eq (len $parts) 2 -}}
      { source: 'tag-{{ index $parts 0 }}', target: 'tag-{{ index $parts 1 }}' },
      {{ end -}}
      {{ end -}}
    ]
  };

  // Remove duplicate links
  const uniqueLinks = [];
  const linkSet = new Set();

  graphData.links.forEach(link => {
    const key = `${link.source}-${link.target}`;
    const reverseKey = `${link.target}-${link.source}`;

    if (!linkSet.has(key) && !linkSet.has(reverseKey)) {
      linkSet.add(key);
      uniqueLinks.push(link);
    }
  });

  graphData.links = uniqueLinks;

  // Initialize the knowledge graph
  window.knowledgeGraph = new KnowledgeGraph('knowledge-graph', graphData, {
    height: 600,
    nodeRadius: 6,
    centerNodeRadius: 12,
    linkDistance: 120,
    chargeStrength: -300
  });

  // Listen for theme switch to prevent animation glitches
  const themeButtons = document.querySelectorAll('.theme-switch');
  themeButtons.forEach(btn => {
    btn.addEventListener('mouseenter', () => {
      if (window.knowledgeGraph) {
        window.knowledgeGraph.pause();
      }
    });
    btn.addEventListener('mouseleave', () => {
      if (window.knowledgeGraph) {
        // Delay resume to allow theme transition to complete
        setTimeout(() => {
          window.knowledgeGraph.resume();
        }, 300);
      }
    });
    btn.addEventListener('click', () => {
      if (window.knowledgeGraph) {
        window.knowledgeGraph.pause();
        // Resume after theme transition completes
        setTimeout(() => {
          window.knowledgeGraph.resume();
        }, 500);
      }
    });
  });

  console.log('Knowledge graph initialized with', graphData.nodes.length, 'nodes and', graphData.links.length, 'links');
});
</script>
